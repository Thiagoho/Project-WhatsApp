const { resolve } = require('path');
const qrcode = require('qrcode-terminal');
const { Client, Buttons, List, MessageMedia } = require('whatsapp-web.js');
const client = new Client();

// Funcionalidade principais do Express:

const express = require('express');
const app = express();

app.get('/', (req, res) => {
    res.send('Hello, Express!');
});
app.listen(3000, () => {
    console.log('Servidor rodando na porta 3000');

 });
const userSessions = {} // Armazena o estado de cada usuÃ¡rio.
//Marca de veÃ­culos no Brasil
const marcasValidas = ["Chevrolet", "Citroen", "Fiat", "Ford", "Jeep", "Nissan",
    "Renault", "Toyota", "Volkswagen", "Hyundai", "Peugeot", "Audi", "Land Rover",
    "Byd"

];
client.on('qr', qr => {
    qrcode.generate(qr, { small: true });
});

client.on('ready', () => {
    console.log('Tudo certo! WhatsApp conectado.');
});

client.initialize();

const delay = ms => new Promise(res => setTimeout(res, ms));

//Criando a funÃ§Ã£o de Temporizador seria o limite de tempo se o usuÃ¡rio deixar de cadastrar,
// recebe uma mensagem.

const iniciarTimeout = (msg) => {
    if (userSessions[msg.from].timeout) {
        clearTimeout(userSessions[msg.from].timeout);
    }
    userSessions[msg.from].timeout = setTimeout(async () => {
        await client.sendMessage(msg.from, "â³ VocÃª nÃ£o completou o cadastro em 3 minutos.\nSeu tempo expirou! Por favor, inicie o processo novamente.");
        delete userSessions[msg.from];
    }, 180000); // 3 minutos (180000ms)
};

client.on('message', async msg => {

    if (msg.body.match(/(menu|Menu|dia|tarde|noite|oi|Oi|OlÃ¡|olÃ¡|ola|Ola)/i) && msg.from.endsWith('@c.us')) {
        const chat = await msg.getChat();
        await delay(3000);
        await chat.sendStateTyping();
        await delay(3000);
        const contact = await msg.getContact();
        const name = contact.pushname;

        // Se for a primeira interaÃ§Ã£o, exibe as opÃ§Ãµes principais
        if (!userSessions[msg.from]) {
            userSessions[msg.from] = { etapa: 'inicio' };
            iniciarTimeout(msg);

            await client.sendMessage(
                msg.from,
                `OlÃ¡! ${name.split(" ")[0]} ğŸ‘‹ Sou o assistente virtual da empresa Lava Jato GaragemğŸ’¦.\n` +
                `Nosso serviÃ§o de lava jato oferece lavagem completa para seu veÃ­culo.\n` +
                `Trabalhamos 7 dias por semana, com agendamento direto pelo WhatsApp.\n\n` +
                `Escolha uma das opÃ§Ãµes a seguir e envie o nÃºmero referente Ã  sua escolha:\n\n` +
                `1ï¸âƒ£ Quero agendar um serviÃ§o.\n` +
                `2ï¸âƒ£ Ver serviÃ§os disponÃ­veis.\n` +
                `3ï¸âƒ£ Ver redes sociais.`
            );
            return;
        }
    }

    // Verifica se o usuÃ¡rio estÃ¡ na etapa inicial e valida a escolha
    if (userSessions[msg.from]?.etapa === 'inicio') {
        if (!['1', '2', '3'].includes(msg.body)) {
            await client.sendMessage(msg.from, 'âŒ OpÃ§Ã£o invÃ¡lida! Por favor, escolha uma opÃ§Ã£o vÃ¡lida digitando o nÃºmero correspondente.');
            return;
        }
        iniciarTimeout(msg);

        if (msg.body === '2') {
            await client.sendMessage(msg.from, `ğŸš— Nossos serviÃ§os disponÃ­veis:\n\nğŸ”¹ Lavagem Simples\nğŸ”¹ Lavagem Completa\nğŸ”¹ Polimento\nğŸ”¹ HigienizaÃ§Ã£o Interna`);
            return;
        }

        const chat = await msg.getChat();
        await delay(3000);
        await chat.sendStateTyping();

        if (msg.body === '3') {
            await client.sendMessage(
                msg.from,
                `ğŸ“² Aqui estÃ£o nossas redes sociais:\n\n` +
                `ğŸ“· Instagram: https://www.instagram.com/lavajatogaragem\n` +
                `ğŸ“˜ Facebook: https://www.facebook.com/lavajatogaragem\n\n` +
                `Caso precise de mais informaÃ§Ãµes, estou Ã  disposiÃ§Ã£o!`
            );
            delete userSessions[msg.from];
            return;
        }



        if (msg.body === '1') { // Aqui estÃ¡ o erro corrigido!
            await client.sendMessage(msg.from,
                `ğŸš— VocÃª escolheu agendar um serviÃ§o.\n\nEscolha o tipo de lavagem desejada:\n\n` +
                `1ï¸âƒ£ Lavagem Simples\n` +
                `2ï¸âƒ£ Lavagem Completa\n` +
                `3ï¸âƒ£ Polimento\n` +
                `4ï¸âƒ£ HigienizaÃ§Ã£o Interna`
            );
            userSessions[msg.from].etapa = 'escolha_servico';
            return;
        }
    }
    if (userSessions[msg.from]?.etapa === 'escolha_servico') {
        const servicos = {
            '1': 'Lavagem Simples',
            '2': 'Lavagem Completa',
            '3': 'Polimento',
            '4': 'HigienizaÃ§Ã£o Interna'
        };
        if (!servicos[msg.body]) {
            await client.sendMessage(msg.from, 'âŒ OpÃ§Ã£o invÃ¡lida! Por favor, escolha uma das opÃ§Ãµes disponÃ­veis.');
            return;
        }
        iniciarTimeout(msg);
        userSessions[msg.from].servicoEscolhido = servicos[msg.body];
        userSessions[msg.from].etapa = 'placa';

        await client.sendMessage(msg.from, `âœ… ServiÃ§o escolhido: ${servicos[msg.body]}\n\nâ¡ï¸ Agora, informe a placa do seu carro (Exemplo: ABC1D23 ou ABC-1234):`);
        return;
    }

    // Cadastro do veÃ­culo - placa
    if (userSessions[msg.from]?.etapa === 'placa') {
        const placaRegex = /^[A-Z]{3}-\d{4}$|^[A-Z]{3}\d[A-Z]\d{2}$/i;
        if (!placaRegex.test(msg.body)) {
            await delay(3000);
            await client.sendMessage(msg.from, 'âŒ Placa invÃ¡lida! Informe no formato correto (AAA-1234 ou ABC1D23).');
            return;
        }

        iniciarTimeout(msg);

        userSessions[msg.from].placa = msg.body.toUpperCase();
        userSessions[msg.from].etapa = 'marca';

        await client.sendMessage(msg.from, `âœ… Placa registrada: ${msg.body.toUpperCase()}\nâ¡ï¸ Agora, informe a marca do veÃ­culo:`);
        return;
    }

    // Cadastro do veÃ­culo - Marca
    if (userSessions[msg.from]?.etapa === 'marca') {
        let marcaInformada = msg.body.trim();
        if (marcasValidas.includes(marcaInformada)) {
            userSessions[msg.from].marca = marcaInformada;
            const { placa } = userSessions[msg.from];

            await delay(3000);
            await client.sendMessage(
                msg.from,
                `âœ… Cadastro completo!\n\n` +
                `ğŸ”¹ Placa: ${placa}\n` +
                `ğŸ”¹ Marca: ${marcaInformada}\n\n` +
                `Agora vocÃª pode agendar seu atendimento!`
            );
            delete userSessions[msg.from];
        } else {
            await delay(3000);
            await client.sendMessage(
                msg.from,
                `âŒ A marca "${marcaInformada}" nÃ£o estÃ¡ cadastrada.\n` +
                `Por favor, informe uma marca vÃ¡lida da lista:\n${marcasValidas.join(', ')}`
            );
        }
        return;
    }
});

